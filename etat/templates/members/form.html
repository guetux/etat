{% extends "modal.html" %}
{% load i18n bootstrap %}

{% block title %}
    {% if member %}
        {{ member.fullname }}
        {% if member.scout_name %}v/o {{ member.scout_name}}{% endif %}
    {% else %}
        {% trans "Add new member" %}
    {% endif %}
{% endblock %}

{% block content %}
<form action="{{ request.path }}" method="post" enctype="multipart/form-data"
    class="member-form {% if member %} edit {% else %} add {% endif %}">
    {% csrf_token %}

    <ul class="nav nav-tabs member-tab-nav">
      <li><a href="#person" data-toggle="tab">
            <i class="icon-user"></i> {% trans "Person" %}</a></li>
      <li><a href="#addresses" data-toggle="tab">
            <i class="icon-envelope"></i> {% trans "Addresses" %}</a></li>
      <li><a href="#roles" data-toggle="tab">
            <i class="icon-shield"></i> {% trans "Roles" %}</a></li>
      <li><a href="#notes" data-toggle="tab">
            <i class="icon-file-text"></i> {% trans "Notes" %}</a></li>
    </ul>
    <div class="tab-content member-tabs">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for non_field_error in form.non_field_errors %}
                     {{ non_field_error }}
                {% endfor %}
            </div>
        {% endif %}

        {% for field in form.hidden_fields %}
            {{ field }}
        {% endfor %}

        <div class="tab-pane" id="person">
            <div class="row">
                <div class="col-md-6">
                    {{ form.scout_name|bootstrap }}
                    {{ form.first_name|bootstrap }}
                    {{ form.last_name|bootstrap }}
                    <div class="form-group">
                        <label class="control-label">
                            {{ form.gender.label }}
                        </label>
                        <div class="btn-group full" data-toggle="buttons">
                            <label class="btn btn-default half">
                              <input type="radio" name="gender" value="m">
                              <i class="icon-male"></i>
                              Gentleman
                            </label>
                            <label class="btn btn-default half" >
                              <input type="radio" name="gender" value="f" >
                              <i class="icon-female"></i>
                              Lady
                            </label>
                        </div>
                    </div>
                    {{ form.birthday|bootstrap }}
                </div>
                <div class="col-md-6">
                    {{ form.portrait|bootstrap }}
                    {{ form.email|bootstrap }}
                    {{ form.mobile|bootstrap }}
                </div>
            </div>
        </div>
        <div class="tab-pane formset" id="addresses">
            <div class="form-horizontal">
                {{ address_formset.management_form }}
                {% for address in address_formset %}
                    <div class="row space {% if forloop.last %}extra{% endif %}">
                        {% for field in address.hidden_fields %}
                            {{ field }}
                        {% endfor %}
                        <div class="col-md-6">
                            {{ address.street|bootstrap_horizontal }}
                            {{ address.postal_code|bootstrap_horizontal }}
                            {{ address.country|bootstrap_horizontal }}
                            {{ address.main|bootstrap_horizontal }}
                        </div>
                        <div class="col-md-6">
                            {{ address.addition|bootstrap_horizontal }}
                            {{ address.city|bootstrap_horizontal }}
                            {{ address.phone|bootstrap_horizontal }}
                            {{ address.DELETE|bootstrap_horizontal }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="tab-pane formset" id="roles">
            <div class="form-inline">
                {{ roles_formset.management_form }}
                <table class="table">
                    <tr>
                        <th width="25%">{% trans "Department" %}</th>
                        <th width="25%">{% trans "Role" %}</th>
                        <th width="20%">{% trans "start" %}</th>
                        <th width="20%">{% trans "end" %}</th>
                        <th width="10%">{% trans "Delete" %}</th>
                    </tr>
                    {% for role in roles_formset %}
                        {% for field in role.hidden_fields %}
                            {{ field }}
                        {% endfor %}
                        <tr class="{% if role.non_field_errors %}danger{% endif %}
                            {% if forloop.last and not role.errors %}extra{% endif %}">
                            <td class="chose">{{ role.department|bootstrap_inline }}</td>
                            <td class="chose">{{ role.type|bootstrap_inline }}</td>
                            <td>{{ role.start|bootstrap_inline }}</td>
                            <td>{{ role.end|bootstrap_inline  }}</td>
                            <td>{{ role.DELETE }}</td>
                        </tr>
                    {% endfor %}
                </table>

                {% for role in roles_formset %}
                    {% if role.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ role.non_field_errors }}
                        </div>
                    {% endif %}
                {% endfor %}
                {% for non_form_error in roles_formset.non_form_errors %}
                    <div class="alert alert-danger">
                        {{ non_form_error }}
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="tab-pane" id="notes">
            {{ form.notes|bootstrap }}
        </div>
    </div>
{% endblock %}

{% block footer %}
<div class="modal-footer {% if member %} edit {% else %} add {% endif %}">
    <button id="add-address" class="btn btn-success pull-left">
        {% trans "Add Address" %}
    </button>
    <button id="add-role" class="btn btn-warning pull-left">
        {% trans "Add Role" %}
    </button>

    <input type="submit" class="btn btn-primary" value="{% trans 'Save' %}">
</div>

<script>
    $('.member-tab-nav a').click(function() {
        $(this).tab('show');
    })
    {% if form.errors %}
        $('a[href=#person]').tab('show');
    {% elif address_formset.has_errors %}
        $('a[href=#addresses]').tab('show');
    {% elif roles_formset.has_errors %}
        $('a[href=#roles]').tab('show');
    {% else %}
        $('.member-tab-nav a:first').tab('show');
    {% endif %}

    $('input[name=gender][value={{ form.gender.value }}]').click();

    $('#add-address').click(function () {
        $('a[href=#addresses]').tab('show');
        $('#addresses .extra').fadeIn();
        $(this).prop('disabled', true);
        return false;
    })

    $('#add-role').click(function () {
        $('a[href=#roles]').tab('show');
        $('#roles .extra').fadeIn();
        $(this).prop('disabled', true);
        return false;
    })

    function currentDate() {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1;
        var yyyy = today.getFullYear();
        return dd + '.' + mm + '.' + yyyy;
    }

    // // preselect new role deparmtent and type (if possible) for new roles
    if ($('.member-form').hasClass('add')) {
        var deptree = jQuery.jstree._reference('#department_tree');
        var selected = _(deptree.get_selected()).first();
        if (selected) {
            var dep = $(selected);
            var id = dep.attr('id');
            var default_role = dep.data('default_role');
            $('#roles .extra select[name$=department]:first').val(id);
            $('#roles .extra select[name$=type]:first').val(default_role);
            $('#roles .extra input[name$=start]:first').val(currentDate());
        }
    }

    $('input[name$=main]').change(function (e) {
        $('input[name$=main][id!='+this.id+']').prop('checked', false);
    })

    $(".member-form select").chosen({width: '100%'});
    $(".datepicker").datepicker({format: 'dd.mm.yyyy'});
</script>

</form>
{% endblock %}